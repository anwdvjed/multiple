# 多模态模型训练配置文件
# config.yaml

# ==================== 路径配置 ====================
paths:
  # 数据根目录
  data_root: "./data"
  
  # 各数据集路径
  datasets:
    coco:
      images: "${paths.data_root}/coco/images"
      annotations: "${paths.data_root}/coco/annotations"
    
    cc3m:
      root: "${paths.data_root}/cc3m"
      tsv_file: "${paths.data_root}/cc3m/cc3m.tsv"
    
    clotho:
      root: "${paths.data_root}/clotho"
    
    audiocaps:
      root: "${paths.data_root}/audiocaps"
    
    voxceleb:
      root: "${paths.data_root}/voxceleb"
  
  # 输出路径
  output_dir: "./outputs"
  checkpoint_dir: "./checkpoints"
  log_dir: "./logs"

# ==================== 数据配置 ====================
data:
  # 图像配置
  image:
    size: 224
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]
  
  # 音频配置
  audio:
    sample_rate: 16000
    n_mels: 80
    n_fft: 1024
    hop_length: 256
    max_duration: 10.0  # 秒
  
  # 文本配置
  text:
    max_length: 256
    vocab_size: 32000
    tokenizer: "bert-base-uncased"
  
  # 数据加载
  num_workers: 4
  pin_memory: true
  prefetch_factor: 2

# ==================== 模型配置 ====================
model:
  # 模型规模: tiny, small, base, large
  size: "base"
  
  # 模型参数
  embed_dim: 512
  num_heads: 8
  mlp_ratio: 4.0
  dropout: 0.1
  
  # 各分支深度
  vision_depth: 8
  text_depth: 8
  audio_depth: 4
  cross_modal_depth: 2
  
  # 显存优化
  use_checkpoint: true
  
  # 输出
  num_classes: 1000

# ==================== 训练配置 ====================
training:
  # 基础设置
  epochs: 100
  batch_size: 8
  gradient_accumulation_steps: 4
  
  # 学习率
  learning_rate: 1.0e-4
  min_lr: 1.0e-6
  weight_decay: 0.05
  
  # 学习率调度
  warmup_epochs: 5
  lr_scheduler: "cosine"
  
  # 显存优化
  use_amp: true
  max_grad_norm: 1.0
  target_memory_gb: 20.0
  
  # 损失权重
  cls_loss_weight: 1.0
  contrastive_loss_weight: 0.5
  temperature: 0.07
  
  # 保存和日志
  save_every: 5
  log_every: 100
  eval_every: 1
  
  # 早停
  early_stopping:
    enabled: true
    patience: 10
    min_delta: 0.001

# ==================== 训练阶段配置 ====================
stages:
  # 阶段1: 单模态预训练
  stage1:
    enabled: true
    name: "单模态预训练"
    epochs: 30
    datasets:
      - "coco"
      - "clotho"
    freeze_modules: []
    learning_rate: 1.0e-4
  
  # 阶段2: 跨模态对齐
  stage2:
    enabled: true
    name: "跨模态对齐"
    epochs: 40
    datasets:
      - "coco"
      - "audiocaps"
    freeze_modules:
      - "vision_branch"
      - "text_branch"
      - "audio_branch"
    learning_rate: 5.0e-5
  
  # 阶段3: 全模型微调
  stage3:
    enabled: true
    name: "全模型微调"
    epochs: 30
    datasets:
      - "coco"
      - "audiocaps"
      - "voxceleb"
    freeze_modules: []
    learning_rate: 1.0e-5

# ==================== 评估配置 ====================
evaluation:
  metrics:
    - "accuracy"
    - "loss"
    - "retrieval_recall"
  
  # 检索评估
  retrieval:
    k_values: [1, 5, 10]

# ==================== 硬件配置 ====================
hardware:
  # GPU设置
  device: "cuda"
  gpu_ids: [0]
  
  # 分布式训练 (可选)
  distributed: false
  world_size: 1
  
  # 随机种子
  seed: 42

# ==================== 日志配置 ====================
logging:
  level: "INFO"
  
  # TensorBoard
  tensorboard:
    enabled: true
    log_dir: "${paths.log_dir}/tensorboard"
  
  # Weights & Biases (可选)
  wandb:
    enabled: false
    project: "multimodal-model"
    entity: null
